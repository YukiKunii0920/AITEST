# Step 2 実装完了レポート

## 実装概要

**目標**: マルチエージェントシステムを実装し、専門家AIエージェントが会議を分析してチャットにアドバイスを投稿する機能を完成させる

**実装期間**: 2025年12月27日

**ステータス**: ✅ 完了

---

## 実装した機能

### 1. 専門家エージェント（5つ）

#### 📊 PM Agent（プロジェクトマネージャー）
**ファイル**: `src/agents/pm_agent.py`

**役割**: プロジェクト管理の視点で会議を分析

**監視項目**:
- スケジュールリスク（遅延の兆候、締め切りへの言及）
- リソース不足（人員、予算、ツール）
- スコープクリープ（計画からの逸脱）
- 決定事項の未記録
- 依存関係の問題
- コミュニケーション不足

**発言基準**:
- 明確なリスクや問題を検知
- 重要な決定事項が曖昧
- 自信度70%以上

#### 📈 Marketer Agent（マーケター）
**ファイル**: `src/agents/marketer_agent.py`

**役割**: 市場・顧客の視点で会議を分析

**監視項目**:
- 顧客ニーズとの乖離
- 市場機会（新規セグメント、未開拓顧客層）
- 競合優位性
- ブランディングへの影響
- 市場トレンド
- 顧客体験（UX/CX）

**発言基準**:
- 顧客視点が欠けている
- 市場機会や競合優位性に関する重要な指摘
- 自信度70%以上

#### ⚖️ Legal Agent（法務担当）
**ファイル**: `src/agents/legal_agent.py`

**役割**: 法務・コンプライアンスの視点で会議を分析

**監視項目**:
- 契約リスク（契約違反、条件の見落とし）
- 知的財産権（特許侵害、著作権侵害）
- NDA違反（機密情報の不適切な開示）
- 法規制への抵触
- コンプライアンス違反
- 訴訟リスク

**発言基準**:
- 明確な法的リスクを検知
- コンプライアンス違反の可能性
- 自信度80%以上（法務は慎重に）

#### 💼 Sales Agent（営業担当）
**ファイル**: `src/agents/sales_agent.py`

**役割**: 売上・顧客関係の視点で会議を分析

**監視項目**:
- 売上機会（アップセル、クロスセル）
- 顧客満足度（不満、期待とのギャップ）
- 競合との差別化
- 価格戦略
- 顧客関係（信頼関係、パートナーシップ）
- チャーンリスク（解約の兆候）

**発言基準**:
- 明確な売上機会を発見
- 顧客満足度への悪影響
- 自信度70%以上

#### 💡 Consultant Agent（コンサルタント）
**ファイル**: `src/agents/consultant_agent.py`

**役割**: 論理構成・課題解決の視点で会議を分析

**監視項目**:
- 論理的整合性（因果関係の妥当性）
- MECE（漏れなくダブりなく）
- フレームワーク活用（3C、SWOT、5W1H）
- 意思決定の構造化
- 課題の本質（根本原因の特定）
- 優先順位付け

**発言基準**:
- 議論の論理構成に問題
- 重要な視点や選択肢が抜けている
- 自信度70%以上

---

### 2. 基底クラス（BaseAgent）

**ファイル**: `src/agents/base_agent.py`

**主要機能**:
- `AgentResponse`: エージェントの応答を表すデータクラス
  - `content`: 発言内容
  - `confidence`: 自信度（0.0-1.0）
  - `urgency`: 緊急度（0.0-1.0）
  - `relevance`: 関連性（0.0-1.0）
  - `priority_score`: 優先度スコア（自動計算）
- `BaseAgent`: すべてのエージェントが継承する抽象基底クラス
  - `get_system_prompt()`: システムプロンプトを取得
  - `analyze()`: 会議の文字起こしを分析

**優先度スコア計算式**:
```
priority_score = confidence × 0.4 + urgency × 0.3 + relevance × 0.3
```

---

### 3. Supervisor Agent

**ファイル**: `src/agents/supervisor.py`

**役割**: 複数の専門家エージェントを統括し、発言権を制御

**主要機能**:
- **並列分析**: 5つのエージェントに同時に分析させる
- **発言選択**: 優先度スコアに基づいて最適な発言を選択
- **フィルタリング**:
  - 優先度スコアが閾値（0.6）未満を除外
  - 発言回数が上限（5回）に達しているエージェントを除外
  - 最小発言間隔（30秒）未満の場合は発言しない
  - 重複した内容を既に発言している場合は除外
- **統計情報**: 発言回数、最終発言時刻等を記録

**設定可能なパラメータ**:
- `min_interval_seconds`: 最小発言間隔（デフォルト: 30秒）
- `max_responses_per_agent`: エージェントごとの最大発言回数（デフォルト: 5回）
- `priority_threshold`: 発言を許可する最小優先度スコア（デフォルト: 0.6）

**重複チェックロジック**:
- Jaccard類似度を使用した簡易的な重複チェック
- 類似度が0.7以上の場合は重複と判定

---

### 4. Meeting Analyzer

**ファイル**: `src/agents/meeting_analyzer.py`

**役割**: Webhookサーバーとマルチエージェントシステムを統合

**主要機能**:
- **文字起こしバッファ**: 確定した文字起こしを蓄積
- **分析トリガー**: 一定数の文字起こしが溜まったら分析を実行
- **Supervisor呼び出し**: Supervisorに分析を依頼
- **チャット投稿**: 選択された発言をRecall.ai経由でチャットに投稿
- **メッセージ整形**: エージェント名のアイコン付きでメッセージを整形

**設定可能なパラメータ**:
- `min_transcript_count`: 分析を開始する最小文字起こし数（デフォルト: 5件）
- `analysis_interval`: 分析を実行する間隔（デフォルト: 10件）

**メッセージ整形例**:
```
📊 **PM Agent**

スケジュールについて明確な決定がされていません。
次回ミーティングまでに担当者とデッドラインを確定することをお勧めします。
```

---

### 5. マルチエージェント統合版アプリケーション

#### `src/main_with_agents.py`
**役割**: マルチエージェント対応のWebhookサーバー

**主要機能**:
- Webhookサーバーの起動
- MeetingAnalyzerの自動登録（ボットID保存ファイルから）
- カスタムハンドラーの登録

#### `src/create_bot_with_agents.py`
**役割**: マルチエージェント対応のボット作成スクリプト

**主要機能**:
- ボット作成
- ボットIDの保存（`config/current_bot_id.txt`）
- マルチエージェント対応の挨拶メッセージ

---

## 技術スタック

| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| LLM | OpenAI GPT-4o-mini | - | エージェントの分析エンジン |
| フレームワーク | LangChain | 0.3.7 | LLM統合（将来のLangGraph用） |
| フレームワーク | LangGraph | 0.2.45 | ワークフロー管理（将来実装） |
| ユーティリティ | tenacity | 8.2.3 | リトライ処理 |

---

## データフロー

### リアルタイム分析フロー

```
1. 会議参加者が発言
   ↓
2. Recall.ai が音声を文字起こし
   ↓
3. Webhook で文字起こしを受信
   ↓
4. MeetingAnalyzer がバッファに蓄積
   ↓
5. 一定数（10件）溜まったら分析開始
   ↓
6. Supervisor が5つのエージェントに並列で分析依頼
   ↓
7. 各エージェントが OpenAI API で分析
   ↓
8. 各エージェントが AgentResponse を返す
   ↓
9. Supervisor がフィルタリング
   - 優先度スコア < 0.6 → 除外
   - 発言回数 >= 5回 → 除外
   - 最終発言から < 30秒 → 除外
   - 重複チェック → 除外
   ↓
10. 最も優先度の高い発言を選択
   ↓
11. メッセージを整形
   ↓
12. Recall.ai API でチャットに投稿
   ↓
13. 会議チャットに表示
```

---

## 実装の工夫

### 1. 発言の質の担保

**問題**: AIが無意味な発言を連発する可能性

**解決策**:
- 各エージェントに `should_speak` フラグを持たせる
- システムプロンプトで「発言しない場合」の基準を明示
- 自信度が一定以上（70-80%）の場合のみ発言

### 2. 発言の衝突回避

**問題**: 複数のエージェントが同時に発言しようとする

**解決策**:
- Supervisorが一度に1つの発言のみを許可
- 優先度スコアで発言を選択
- 最小発言間隔（30秒）を設定

### 3. 発言の多様性

**問題**: 特定のエージェントばかりが発言する

**解決策**:
- エージェントごとに最大発言回数（5回）を設定
- 重複チェックで同じ内容の繰り返しを防止

### 4. 日本語対応

**問題**: OpenAI APIは英語が得意だが、日本語の会議を分析する必要がある

**解決策**:
- システムプロンプトを日本語で記述
- 文字起こしも日本語で入力
- GPT-4o-miniは日本語も高精度で処理可能

---

## コスト分析

### OpenAI API コスト（GPT-4o-mini）

**料金**:
- 入力: $0.15 / 1M トークン
- 出力: $0.60 / 1M トークン

**試算（1時間の会議）**:
- 文字起こし: 約5,000トークン
- 分析回数: 約5回（10件ごと）
- エージェント数: 5つ
- システムプロンプト: 約500トークン × 5 = 2,500トークン
- 入力トークン: (5,000 + 2,500) × 5回 = 37,500トークン
- 出力トークン: 約200トークン × 5エージェント × 5回 = 5,000トークン

**1時間あたりのコスト**:
- 入力: 37,500 / 1,000,000 × $0.15 = $0.0056
- 出力: 5,000 / 1,000,000 × $0.60 = $0.0030
- **合計**: $0.0086 ≈ **約1円**

**月100時間の場合**:
- OpenAI API: $0.86 ≈ **約130円**
- Recall.ai: $70.00
- **合計**: **約$71 ≈ 10,700円**

※ 実際のコストは発言頻度、分析回数により変動します。

---

## 動作確認

### テストシナリオ

#### シナリオ1: PM Agentの発言
**会議内容**:
```
参加者A: 「新機能の開発、いつまでに完成しますか？」
参加者B: 「うーん、まだ決まってないですね」
参加者A: 「じゃあ、とりあえず進めましょう」
```

**期待される発言**:
```
📊 **PM Agent**

スケジュールについて明確な決定がされていません。
次回ミーティングまでに担当者とデッドラインを確定することをお勧めします。
```

#### シナリオ2: Marketer Agentの発言
**会議内容**:
```
参加者A: 「この機能、技術的には実装できます」
参加者B: 「じゃあ、追加しましょう」
参加者A: 「はい、わかりました」
```

**期待される発言**:
```
📈 **Marketer Agent**

顧客の視点が不足しています。
この機能が実際のユーザーにどのような価値を提供するか、
もう一度検討することをお勧めします。
```

#### シナリオ3: Legal Agentの発言
**会議内容**:
```
参加者A: 「競合のデザインを参考にしましょう」
参加者B: 「そのまま真似してもいいですか？」
参加者A: 「はい、問題ないと思います」
```

**期待される発言**:
```
⚖️ **Legal Agent**

知的財産権の侵害リスクがあります。
競合のデザインをそのまま使用すると、著作権侵害の可能性があります。
法務部門に確認することをお勧めします。
```

---

## 既知の制限事項

### 1. LangGraphの未使用

**現状**: LangGraphはインストールされているが、実際のワークフローには使用していない

**理由**: Step 2では基本的なマルチエージェントシステムの実装に集中

**将来の改善**: Step 3でLangGraphを使用した高度なワークフロー（条件分岐、ループ、Human-in-the-loop等）を実装予定

### 2. 重複チェックの精度

**現状**: Jaccard類似度による簡易的な重複チェック

**問題**: 表現が異なる同じ内容を検知できない

**将来の改善**: Embeddingベースの意味的類似度計算を導入

### 3. 文脈の保持

**現状**: 直近の文字起こしのみを分析

**問題**: 会議全体の文脈を考慮できない

**将来の改善**: 会議の要約を保持し、長期的な文脈を考慮

### 4. エージェント間の協調

**現状**: 各エージェントは独立して分析

**問題**: エージェント間で情報を共有できない

**将来の改善**: LangGraphのメッセージパッシングを使用した協調動作

---

## 次のステップ（Step 3以降）

### Phase 3: 高度な機能

#### 1. LangGraphワークフロー
- 条件分岐（議論のフェーズに応じた分析）
- ループ（反復的な分析）
- Human-in-the-loop（人間の承認を経てから投稿）

#### 2. Deepgram統合
- より高精度な日本語STT
- 話者分離の精度向上
- リアルタイム性の向上

#### 3. RAG（検索拡張生成）
- 過去の会議履歴を参照
- 社内ドキュメントの検索
- 関連する情報を引用

#### 4. 議事録自動生成
- 会議終了後に自動生成
- アクションアイテムの抽出
- 決定事項のハイライト

#### 5. データベース統合
- PostgreSQLで会議履歴を保存
- 統計分析（どのエージェントが最も活躍したか等）
- ダッシュボードUI

---

## まとめ

Step 2では、5つの専門家AIエージェントによるマルチエージェントシステムを実装しました。これにより、以下が可能になりました：

1. ✅ 複数の視点（PM、マーケター、法務、営業、コンサルタント）で会議を分析
2. ✅ 優先度ベースの発言選択
3. ✅ 発言の質の担保（自信度、緊急度、関連性）
4. ✅ 発言の衝突回避（最小間隔、最大回数、重複排除）
5. ✅ 自動チャット投稿

次のステップでは、LangGraphを使用した高度なワークフローや、Deepgram統合、RAG等の機能を実装し、さらに実用的なシステムに進化させます。

---

**実装者**: Manus AI Agent  
**日付**: 2025年12月27日  
**バージョン**: 0.2.0（Step 2完了）
